# o1scraper

o1scraperは、ChatGPTの会話から折りたたまれたテキストデータを自動的に抽出し、JSON形式で保存するPythonベースのツールです。Playwrightを使用したウェブ自動化機能を備えており、環境セットアップを自動化することで使いやすさを向上させています。

## 特徴

- 自動的な仮想環境のセットアップ
- Playwrightのインストールと管理
- ChatGPT会話からの折りたたまれたテキスト要素の抽出
- タイムスタンプベースのファイル名でのJSON出力
- 抽出データの逆時系列順でのソート

## 前提条件

- Windows 10
- Python 3.7以上
- モダンなウェブブラウザ（例：Microsoft Edge、Google Chrome）
- ブラウザをリモートデバッグモードで起動する必要があります

## セットアップ

1. **リポジトリのクローンまたはダウンロード**
   
   このリポジトリをローカルマシンにクローンするか、ZIPファイルとしてダウンロードして解凍してください。

2. **プロジェクトディレクトリへの移動**
   
   コマンドプロンプトを開き、プロジェクトディレクトリに移動します：
   ```bash
   cd path\to\o1scraper
   ```

3. **スクリプトの実行**
   
   以下のコマンドを実行します：
   ```bash
   python main.py
   ```

   スクリプトは以下の手順を自動的に実行します：
   
   - 仮想環境`o1scraper`の存在を確認し、存在しない場合は作成します。
   - 新しいコマンドプロンプトウィンドウを開き、そこで仮想環境をアクティベートし、`main.py`を再実行します。
   - 仮想環境内で必要な依存関係をインストールします。
   - スクレイピング処理を実行します。

   **注意**: 初回実行時は仮想環境の作成と依存関係のインストールに時間がかかる場合があります。一度セットアップが完了すれば、次回以降の実行は高速になります。

## 使用方法

1. **ブラウザのリモートデバッグモードでの起動**
   
   リモートデバッグを有効にしてブラウザを起動します。以下はMicrosoft Edgeを使用する例です。必要に応じてブラウザのパスやオプションを調整してください。

   - **Microsoft Edgeの場合**:
     
     ショートカットを作成し、ターゲットフィールドに以下を追加します：
     ```
     "C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe" --remote-debugging-port=9222 --user-data-dir="C:\edge_debug"
     ```
     
     **注**: このコマンドは例です。ブラウザの実行ファイルのパスやオプションは環境に応じて変更してください。重要なのは`--remote-debugging-port=9222`フラグです。

2. **ChatGPT会話ページの準備**
   
   ブラウザでChatGPTを開き、データを抽出したい会話ページに移動します。

3. **スクリプトの実行**
   
   再度コマンドプロンプトを開き、プロジェクトディレクトリに移動してスクリプトを実行します：
   ```bash
   cd path\to\o1scraper
   python main.py
   ```

   スクリプトは新しいコマンドプロンプトウィンドウを開き、仮想環境をアクティベートした状態で処理を実行します。処理が完了すると、仮想環境から抜けます。

## 出力

抽出されたデータは、現在のディレクトリにタイムスタンプベースのファイル名（例：`extracted_data_1726404502.json`）で保存されます。JSONファイルには、各オブジェクトが`id`と`content`フィールドを持つ配列が含まれます。

## トラブルシューティング

- **スクリプトがChatGPTページを見つけられない場合**:
  - ブラウザがリモートデバッグモードで起動されていることを確認してください。
  - ChatGPTの会話ページが正しく開かれているか確認してください。

- **パーミッション関連の問題**:
  - コマンドプロンプトを管理者として実行してみてください。

- **依存関係に関連する問題**:
  - プロジェクトディレクトリから`o1scraper`フォルダを削除し、再度スクリプトを実行して仮想環境を再作成してください。

- **Playwrightに関連する問題**:
  ```bash
  pip install playwright
  playwright install chromium
  ```
  手動でインストールを試みてください。

- **使用するブラウザが異なる場合**:
  - Microsoft Edge以外のブラウザを使用する場合は、ブラウザ起動時のコマンドを適宜調整してください。

## ログの確認

スクリプトの実行中は、コマンドプロンプトにログが表示されます。ログには以下のような情報が含まれます：

- 仮想環境のセットアップ状況
- Playwrightのインストール状況
- ChatGPTページの検出状況
- データの保存状況
- エラーメッセージ（発生した場合）

**例**:
```
2024-09-15 21:55:42,097 - INFO - Virtual environment already exists.
2024-09-15 21:55:42,097 - INFO - Launching a new terminal with the virtual environment activated...
```

## コードの概要

`main.py`は以下の機能を実装しています：

1. **仮想環境の確認と作成**:
   - `o1scraper`という名前の仮想環境が存在しない場合は作成します。
   - 既に存在する場合はスキップします。

2. **新しいターミナルウィンドウでの仮想環境の有効化とスクリプトの再実行**:
   - Windowsでは`cmd.exe`を使用して新しいCMDウィンドウを開き、そこで仮想環境をアクティベートし、スクリプトを再実行します。
   - スクリプト実行後、メインのプロセスは終了します。

3. **依存関係のインストール**:
   - `requirements.txt`が存在する場合は、そこに記載されたパッケージをインストールします。
   - 存在しない場合は、`playwright`を直接インストールします。
   - Playwrightのブラウザ（Chromium）もインストールします。

4. **スクレイピングの実行**:
   - Playwrightを使用してリモートデバッグポートで実行中のブラウザに接続します。
   - ChatGPTの会話ページを検出し、折りたたまれたテキスト要素を抽出します。
   - 抽出データをJSONファイルに保存します。

## 貢献

貢献は大歓迎です！プルリクエストを送信してください。

## ライセンス

このプロジェクトはMITライセンスの下でライセンスされています。詳細については、[LICENSE](LICENSE)ファイルを参照してください。

## 免責事項

このツールは教育目的のみで使用してください。スクリプトを使用する際は、OpenAIの利用規約および適用される法律や規制を遵守してください。

---

## 追加の改善点と推奨事項

現在のスクリプトの動作に基づき、以下の追加改善点を検討することをお勧めします：

1. **エラーハンドリングの強化**:
   - Playwrightによるページ操作中に発生するエラー（例：「Page.query_selector_all: Execution context was destroyed, most likely because of a navigation」）に対処するため、適切な待機処理や再試行ロジックを追加します。

2. **ログファイルの導入**:
   - 実行ログをファイルに保存することで、後から実行状況を確認しやすくなります。`logging`モジュールの設定を変更して、ログをファイルにも出力するように設定できます。

   ```python
   logging.basicConfig(
       level=logging.INFO,
       format='%(asctime)s - %(levelname)s - %(message)s',
       handlers=[
           logging.FileHandler("scraper.log"),
           logging.StreamHandler(sys.stdout)
       ]
   )
   ```

3. **ブラウザの自動起動**:
   - Playwrightを使用してブラウザを自動的に起動し、リモートデバッグモードを有効にするスクリプトを追加することで、ユーザーが手動でブラウザを起動する手間を省けます。

4. **コマンドライン引数の導入**:
   - スクリプトに柔軟性を持たせるために、ターゲットURLや出力ファイル名を指定できるように`argparse`モジュールを使用してコマンドライン引数を受け付ける機能を追加します。

5. **ユニットテストの追加**:
   - スクリプトの各機能に対してユニットテストを追加し、信頼性と保守性を向上させます。

6. **依存関係の管理の改善**:
   - 必要なパッケージを`requirements.txt`に明示的に記載し、将来的な依存関係の追加や管理を容易にします。